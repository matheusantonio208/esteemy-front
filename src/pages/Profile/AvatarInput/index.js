import React, { useState, useRef, useEffect } from 'react';
import { useField } from '@rocketseat/unform';
import api from '~/services/api';

import { Container } from './styles';

export default function AvatarInput() {
  const { defaultValue, registerField } = useField('avatar');

  const [file, setFile] = useState(defaultValue && defaultValue.id);
  const [preview, setPreview] = useState(defaultValue && defaultValue.url);

  const ref = useRef();

  useEffect(() => {
    if( ref.current) {
      registerField({
        name: 'avatar_id',
        ref: ref.current,
        path: 'dataset.file',
      })
    }
  }, [ref, registerField]);
              

  async function handleChange(e) {
    const data = new FormData();

    data.append('file', e.target.files[0]);

    const response = await api.post('files', data);

    const { id, url } = response.data;

    setFile(id);
    setPreview(url);

  }

  return (
    <Container>
      <label htmlFor="avatar">
        <img src={preview || "data:image/jpeg;base64,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"}alt="" />

        <input
          type="file"
          id="avatar"
          accept="image/*"
          data-file={file}
          onChange={handleChange}
          ref={ref}
        />
      </label>
    </Container>
  );
}
